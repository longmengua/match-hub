# go-match-hub

## 撮合系統 - 系統架構圖

                   +-----------------+
                   |     Client      |
                   +--------+--------+
                            |
                            v
               +------------+-------------+
               |        Web API Server     |
               +------------+-------------+
                            |
              +-------------+-------------+
              |                           |
         REST API                 WebSocket API
              |                           |
              v                           v
+-------------+--------------+   +--------+----------+
|      Order Controller       |  |   Realtime Stream  |
+----------------------------+   +--------------------+
              |
              v
+-------------+-------------+
|     UseCase (PlaceOrder)  |
+-------------+-------------+
              |
              v
+-------------+--------------+
|         Service Layer       |
+----------------------------+
              |
      +-------+--------+
      |                |
      v                v
+-----+-----+   +------+------+
|  Repo     |   |   MQ Pub    |
| (Postgres)|   | (RabbitMQ)  |
+-----------+   +-------------+

                          |
                          v
              +-----------+-----------+
              |      RabbitMQ Queue   |
              +-----------+-----------+
                          |
                          v
               +----------+----------+
               |     Match Engine    |
               +----------+----------+
                          |
             +------------+-----------+
             |                        |
      +------+-----+         +--------+--------+
      | Redis Cache|         |  Matched Order  |
      | (OrderBook)|         |     Handler     |
      +------------+         +--------+--------+
                                       |
                                       v
                           +-----------+------------+
                           |       gRPC Callback     |
                           |  (to Web API Server)    |
                           +-----------+------------+
                                       |
                              +--------+--------+
                              |   Notify Client   |
                              +-------------------+

## 撮合系統 - Data Flow Diagram

### Level 0 DFD（系統總覽）

+-----------+        +------------------+       +-------------+
|  Client   +------->+  Web API Server  +------>+ Match Engine|
+-----------+        +------------------+       +-------------+
       ^                     |                         |
       |                     v                         v
       |             +---------------+         +----------------+
       |             |  PostgreSQL   |         |     Redis      |
       |             +---------------+         +----------------+
       |                     |
       |                     v
       |             +----------------+
       |             | RabbitMQ Queue |
       |             +----------------+
       |                     |
       +<--------------------+
        (Notification / Stream)

### Level 1 DFD（Place Order 詳細流程）

+-----------+
|   Client  |
+-----------+
      |
      v
+-------------------+
|  Place Order API  |
+-------------------+
      |
      v
+-----------------------+
|  Validate & Transform |
+-----------------------+
      |
      v
+---------------------+
|   Save to Database  |
|   (PostgreSQL)      |
+---------------------+
      |
      v
+----------------------+
| Publish to RabbitMQ  |
+----------------------+
      |
      v
+----------------------+
|   Match Engine Sub   |
+----------------------+
      |
      v
+---------------------+
|  Load OrderBook     |
|   (from Redis)      |
+---------------------+
      |
      v
+---------------------+
|   Run Matching Algo |
+---------------------+
      |
      v
+---------------------------+
| Update Redis & Postgres  |
+---------------------------+
      |
      v
+----------------------+
| Push Matched Result  |
| via gRPC to Web API  |
+----------------------+
      |
      v
+------------------+
|  Notify Client   |
+------------------+

## 撮合系統 - 任務分解

### 🌟 功能分解總覽

```
1. API層 (Go + Gin)
   ├── 訂單接收 (接收HTTP請求)
   ├── 訂單驗證 (數據合法性)
   ├── 訂單持久化 (PostgreSQL寫入)
   └── 訂單推送 (發送Kafka事件)

2. 撮合引擎 (Go + Kafka + Redis)
   ├── Kafka訂單消費 (訂單拉取)
   ├── 撮合邏輯 (買賣盤匹配)
   ├── 資料結構管理 (Redis: 跳表/有序集合)
   ├── 成交結果處理 (生成成交事件)
   └── 成交結果持久化 (PostgreSQL寫入)

3. 數據同步與持久化 (PostgreSQL)
   ├── 訂單持久化 (未成交訂單)
   ├── 成交記錄持久化 (成交結果)
   ├── 快照管理 (定時快照)
   └── 數據清理 (歷史訂單清理)

4. 高性能優化
   ├── 非同步處理 (減少主線程阻塞)
   ├── 多線程優化 (撮合併發處理)
   ├── Cache層優化 (Redis操作優化)
   └── 監控與健康檢查 (Prometheus/Grafana)

5. 測試與壓力測試
   ├── 單元測試 (API與撮合邏輯)
   ├── 整體測試 (從API到撮合完整流程)
   ├── 壓力測試 (大量下單模擬)
   └── 故障測試 (Kafka/Redis/PostgreSQL異常)
```

### 🗂️ 任務拆解詳細說明

#### 1. API層 (Go + Gin)

* **職責：** 提供HTTP接口，接收訂單請求。
* **任務分解：**

  * 訂單接收：使用Gin框架建立API，接收POST請求。
  * 訂單驗證：檢查用戶ID、價格、數量是否合法。
  * 訂單持久化：寫入PostgreSQL，異步操作。
  * 訂單推送：將訂單轉為JSON格式推送Kafka。

#### 2. 撮合引擎 (Go + Kafka + Redis)

* **職責：** 從Kafka拉取訂單，進行撮合並更新Redis。
* **任務分解：**

  * Kafka訂單消費：訂閱訂單事件，從Kafka讀取數據。
  * 撮合邏輯：根據買賣盤價格匹配訂單。
  * 資料結構管理：更新Redis有序集合，按價格排序。
  * 成交結果處理：生成成交事件，推送Kafka。
  * 成交結果持久化：寫入PostgreSQL。

#### 3. 數據同步與持久化 (PostgreSQL)

* **職責：** 保存訂單和成交結果，數據持久化。
* **任務分解：**

  * 訂單持久化：存未成交訂單，保證數據一致性。
  * 成交記錄持久化：交易完成後寫入PostgreSQL。
  * 快照管理：定期將訂單簿和交易狀態持久化。
  * 數據清理：定期刪除過期訂單。

#### 4. 高性能優化

* **職責：** 提升系統性能，確保穩定性。
* **任務分解：**

  * 非同步處理：減少阻塞，提升響應速度。
  * 多線程優化：多核併發，提升撮合效率。
  * Cache層優化：Redis操作批量處理，降低延遲。
  * 健康監控：設置Prometheus監控，防故障。

#### 5. 測試與壓力測試

* **職責：** 確保系統穩定性與性能。
* **任務分解：**

  * 單元測試：針對API和撮合核心進行單元測試。
  * 整體測試：涵蓋API層到撮合引擎的完整流程。
  * 壓力測試：模擬高併發訂單流量。
  * 故障測試：模擬Kafka、Redis、PostgreSQL異常情況。
